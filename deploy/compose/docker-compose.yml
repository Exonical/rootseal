services:
  postgres:
    image: postgres:17-alpine
    environment:
      POSTGRES_DB: rootseal
      POSTGRES_USER: rootseal
      POSTGRES_PASSWORD: dev-password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rootseal"]
      interval: 10s
      timeout: 5s
      retries: 5

  vault:
    image: hashicorp/vault:1.20
    cap_add:
      - IPC_LOCK
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: dev-root-token
      VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
      VAULT_ADDR: http://0.0.0.0:8200
    ports:
      - "8200:8200"
    volumes:
      - ./vault-init.sh:/vault-init.sh
    command: >
      sh -c "vault server -dev -dev-root-token-id=dev-root-token -dev-listen-address=0.0.0.0:8200 &
             sleep 5 && /vault-init.sh && wait"
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 5

  rootseal-server:
    build:
      context: ../../
      dockerfile: build/server.Dockerfile
    ports:
      - "50051:50051"
    volumes:
      - ../../configs/server.dev.yaml:/etc/rootseal/server.yaml:ro
      - ../../certs:/etc/rootseal/certs:ro
    depends_on:
      postgres:
        condition: service_healthy
      vault:
        condition: service_healthy
    environment:
      DATABASE_URL: "postgres://rootseal:dev-password@postgres:5432/rootseal?sslmode=disable"
      VAULT_ADDR: "http://vault:8200"
      VAULT_TOKEN: "dev-root-token"
      # TPM PCR policy configuration
      TPM_REQUIRED_PCRS: "0,2,7"  # PCRs required in attestation quotes
      TPM_ENFORCE_PCR_VALUES: "false"  # Set to "true" to enforce specific PCR values
      # KMS provider configuration
      # KMS_PROVIDER: "vault" (default), "aws-kms", "azure-keyvault", "fortanix-sdkms"
      KMS_PROVIDER: "vault"
      # Vault KMS settings (used when KMS_PROVIDER=vault)
      KMS_VAULT_TRANSIT_PATH: "transit"
      KMS_VAULT_KEY_NAME: "recovery-key"
      # AWS KMS settings (used when KMS_PROVIDER=aws-kms)
      # KMS_AWS_KEY_ID: "alias/rootseal-key"
      # AWS_REGION: "us-east-1"
      # Azure Key Vault settings (used when KMS_PROVIDER=azure-keyvault)
      # KMS_AZURE_VAULT_URL: "https://myvault.vault.azure.net"
      # KMS_AZURE_KEY_NAME: "rootseal-key"
      # Fortanix SDKMS settings (used when KMS_PROVIDER=fortanix-sdkms)
      # KMS_FORTANIX_ENDPOINT: "https://sdkms.fortanix.com"
      # KMS_FORTANIX_KEY_ID: "key-uuid"
    command: ["/usr/local/bin/rootseal-server"]

volumes:
  postgres_data:
